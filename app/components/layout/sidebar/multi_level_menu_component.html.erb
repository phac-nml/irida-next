<% control_id = "multi-level-menu_#{title.parameterize.underscore}" %>

<%= tag.li(class: "group/menu list-none mr-1", data: { controller: "collapsible sidebar-item" }) do %>
  <%= tag.button(
    type: "button",
    id: "#{control_id}-button",
    aria: {
      controls: control_id,
      expanded: @selected ? "true" : "false",
    },
    data: {
      action: "click->collapsible#toggle click->sidebar-item#onClick",
      "collapsible-target": "button",
      "sidebar-item-target": "trigger",
      turbo: "false",
    },
    class:
      class_names(
        "flex items-center text-left p-2.5 m-1 rounded-lg transition-colors duration-200 relative focus-visible:z-10 cursor-pointer w-full",
        "bg-primary-100 text-primary-800 dark:bg-slate-800 dark:text-primary-400 font-medium" => selected,
        "text-slate-700 hover:bg-slate-100 dark:text-slate-300 dark:hover:bg-slate-800/70" => !selected,
      ),
  ) do %>
    <%= tag.span(
      class:
        class_names(
          "w-8 h-8 flex items-center justify-center rounded-lg mr-3 flex-shrink-0 transition-colors duration-200",
          "bg-primary-300 text-primary-800 dark:bg-slate-700/90" => @selected,
          "bg-slate-100 text-slate-600 dark:bg-slate-800 dark:text-slate-400 group-hover/menu:bg-slate-200/70 dark:group-hover/menu:bg-slate-700/50" => !@selected,
        ),
    ) do %>
      <%= create_icon %>
    <% end %>

    <%= tag.span(
      title,
      class: "text-sm font-medium transition-opacity duration-200 ease-in-out flex-1",
    ) %>

    <%= tag.span(
      data: { "collapsible-target": "icon" },
      class: class_names("transition-transform duration-200 mr-2 flex-shrink-0", "rotate-180" => @selected),
    ) do %>
      <%= pathogen_icon(:caret_down, size: :sm, color: @selected ? :primary : :default) %>
    <% end %>
  <% end %>

  <%= tag.ul(
    id: control_id,
    data: { "collapsible-target": "item" },
    hidden: !@selected,
    class:
      class_names(
        "py-1 pl-2 space-y-1 overflow-hidden transition-all duration-200 border-l-2 border-slate-100 dark:border-slate-700 ml-6",
        "hidden" => !@selected,
      ),
  ) do %>
    <% menu_items.each do |menu_item| %>
      <%= tag.li(class: "Layout-Sidebar-MultiLevelMenu__Item list-none p-1 pr-2") do %>
        <%= link_to(
          menu_item.url,
          class:
            class_names(
              "flex items-center py-1 pr-1 w-full transition-colors ease-in-out delay-75 focus-:z-10 rounded-lg group min-h-[44px] pl-10",
              "bg-slate-300 text-slate-900 dark:bg-slate-700 dark:text-slate-50" => menu_item.selected,
              "hover:bg-slate-50 dark:hover:bg-slate-500 text-slate-700 dark:text-slate-200 hover:text-slate-900 dark:hover:text-slate-50" => !menu_item.selected,
            ),
          aria: { current: ("page" if menu_item.selected) },
        ) do %>
          <%= tag.span(menu_item.label, class: "grow") %>
          <%= render_icon(menu_item.icon, menu_item.selected) if menu_item.icon.present? %>
        <% end %>
      <% end %>
    <% end %>
  <% end %>
<% end %>
