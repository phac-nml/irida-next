<% control_id = "multi-level-menu_#{title.parameterize.underscore}" %>
<li data-controller="collapsible" class="Layout-Sidebar__Item">
  <button
    type="button"
    class="
      flex items-center w-full mt-1 py-1 pr-1 pl-2 transition-colors ease-in-out
      delay-75 rounded-lg group cursor-pointer min-h-[44px] relative overflow-hidden
      focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-green-500
      <%= class_names({
        # ðŸš€ Modern, accessible selected state (dark+light): strong bg, border, shadow
        'bg-slate-800/90 dark:bg-slate-700/90 text-white border border-slate-600 dark:border-slate-500 shadow-lg shadow-slate-900/10 font-semibold': @selected,
        'hover:bg-slate-100 dark:hover:bg-slate-800 text-slate-700 dark:text-slate-200': !@selected
      }) %>
    "
    aria-controls="<%= control_id %>"
    data-action="collapsible#toggle"
  >
    <span
      class="
        w-8 h-8 flex items-center justify-center rounded-full mr-2
        <%= @selected ? 'bg-slate-700 dark:bg-slate-800' : 'bg-slate-100 dark:bg-slate-800 group-hover:bg-slate-200 dark:group-hover:bg-slate-700' %>
      "
    >
      <%= create_icon %>
    </span>
    <span
      class="
        flex-1 ml-1 text-left rtl:text-right whitespace-nowrap
        <%= @selected ? 'font-semibold text-white dark:text-slate-50' : 'text-slate-700 dark:text-slate-200 group-hover:text-slate-900 dark:group-hover:text-slate-50' %>
      "
    ><%= title %></span>
    <%= viral_icon(
      name: "chevron_down",
      classes:
        class_names(
          "mr-1 w-4 h-4 transition-transform", # Added mr-1 for spacing
          { "rotate-180": @selected },
          (
            if @selected
              "text-white dark:text-slate-50"
            else
              "text-slate-400 group-hover:text-slate-500"
            end
          ),
        ),
      "data-collapsible-target": "icon",
    ) %>
  </button>
  <ul
    id="<%= control_id %>"
    data-collapsible-target="item"
    class="<%= class_names('py-1 space-y-1 pl-8', { 'hidden': !@selected }) %>"
  >
    <% menu_items.each do |menu_item| %>
      <li class="Layout-Sidebar-MultiLevelMenu__Item">
        <a
          href="<%= menu_item.url %>"
          class="
            flex items-center py-1 pr-1 w-full transition-colors ease-in-out delay-75
            rounded-lg group min-h-[44px] pl-10
            <%= class_names({
              'bg-slate-700/80 dark:bg-slate-600/80 text-white font-semibold rounded-full': menu_item.selected, # Modern selected child item
              'hover:bg-slate-100 dark:hover:bg-slate-800 text-slate-700 dark:text-slate-200 hover:text-slate-900 dark:hover:text-slate-50': !menu_item.selected
            }) %>
          "
        >
          <%# Icon container removed %>
          <span
            class="grow <%= menu_item.selected ? 'font-semibold text-white dark:text-slate-50' : 'text-slate-700 dark:text-slate-200 group-hover:text-slate-900 dark:group-hover:text-slate-50' %>"
          >
            <%= menu_item.label %>
          </span>
        </a>
      </li>
    <% end %>
  </ul>
</li>
