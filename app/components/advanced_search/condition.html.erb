<fieldset
  data-advanced-search-target="conditionsContainer"
  data-enum-fields='<%= @enum_fields.to_json %>'
  data-enum-operations='<%= @enum_operations.to_json %>'
  data-standard-operations='<%= @operations.to_json %>'
  class="
    relative p-3 rounded-md border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800/30
    hover:border-slate-300 dark:hover:border-slate-600 transition-colors flex @max-xl:flex-col
    @max-xl:space-y-2 space-x-2 items-start
  "
>
  <legend class="mb-1 block text-sm font-medium text-slate-700 dark:text-slate-300">
    <%= t("components.advanced_search_component.condition", index: @condition_number) %>
  </legend>
  <%= @groups_form.fields_for :conditions, @condition, child_index: @condition_index do |conditions_form| %>
    <% invalid_field = @condition.errors.include?(:field) %>
    <div
      class="
        form-field w-1/3 @max-xl:w-full <%= 'invalid' if invalid_field %>
      "
    >
      <%= conditions_form.label :field, data: { required: true } %>
      <%= conditions_form.select :field,
                             options_for_select(
                               @entity_fields,
                               selected_key = @condition.field,
                             ).concat(
                               grouped_options_for_select(
                                 @jsonb_fields,
                                 selected_key = @condition.field,
                               ),
                             ),
                             { include_blank: true },
                             {
                               "data-action": "advanced-search#handleFieldChange",
                               "aria-label":
                                 t(
                                   translation_key(:field),
                                 ),
                               "aria-invalid": invalid_field,
                               "aria-describedby":
                                 conditions_form.field_id(:field, "error"),
                               autofocus: invalid_field,
                             } %>
      <%= render "shared/form/field_errors",
      errors: @condition.errors.full_messages_for(:field),
      id: conditions_form.field_id(:field, "error") %>
    </div>
    <% invalid_operator = @condition.errors.include?(:operator) %>
    <div
      class="
        form-field w-1/4 @max-xl:w-full <%= 'invalid' if invalid_operator %>
      "
    >
      <%= conditions_form.label :operator, data: { required: true } %>
      <%= conditions_form.select :operator,
                             options_for_select(
                               @operations,
                               selected = @condition.operator,
                             ),
                             { include_blank: true },
                             {
                               "data-action": "advanced-search#handleOperatorChange",
                               "aria-label":
                                 t(
                                   translation_key(:operator),
                                 ),
                               "aria-invalid": invalid_operator,
                               "aria-describedby":
                                 conditions_form.field_id(:operator, "error"),
                               autofocus: invalid_operator,
                             } %>
      <%= render "shared/form/field_errors",
      errors: @condition.errors.full_messages_for(:operator),
      id: conditions_form.field_id(:operator, "error") %>
    </div>
    <%= render AdvancedSearch::Value.new(
      conditions_form: conditions_form,
      group_index: @group_index,
      condition: @condition,
      condition_index: @condition_index,
      enum_fields: @enum_fields,
    ) %>
  <% end %>
  <button
    type="button"
    class="
      flex-shrink-0 inline-flex items-center justify-center w-8 h-8
      text-slate-400 hover:text-slate-700 dark:text-slate-500 dark:hover:text-slate-300
      hover:bg-slate-200 dark:hover:bg-slate-700 rounded-md
      transition-colors cursor-pointer self-start mt-auto ml-auto
    "
    title="<%=t("components.advanced_search_component.remove_condition_aria_label")%>"
    aria-label="<%=t("components.advanced_search_component.remove_condition_aria_label")%>"
    data-action="advanced-search#removeCondition"
  >
    <%= pathogen_icon(:x, size: :sm) %>
  </button>
</fieldset>
