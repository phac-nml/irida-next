<div
  id="nextflow-container"
  data-controller="nextflow--samplesheet"
  data-nextflow--samplesheet-data-missing-error-value="<%= t("components.nextflow_component.data_missing_error") %>"
  data-nextflow--samplesheet-url-value="<%= url %>"
  data-nextflow--samplesheet-workflow-value="<%= {name: @workflow.name, version: @workflow.version }.to_json%>"
  data-nextflow--samplesheet-no-selected-file-value="<%= t("components.nextflow.samplesheet.file_cell_component.no_selected_file")%>"
  data-nextflow--samplesheet-form-error-value="<%= t("general.form.error_notification") %>"
  data-nextflow--samplesheet-automated-workflow-value="<%= @automated_workflow %>"
  data-nextflow--samplesheet-name-missing-value="<%= t("components.nextflow_component.name.error") %>"
  data-nextflow--samplesheet-allowed-to-update-samples-string-value="<%= t("components.nextflow.update_samples")%>"
  data-nextflow--samplesheet-not-allowed-to-update-samples-string-value="<%= t("components.nextflow.unauthorized_to_update_samples")%>"
  data-nextflow--samplesheet-processing-error-value="<%= t("components.nextflow_component.samplesheet_processing_error")%>"
  <% unless @automated_workflow %>
  data-nextflow--samplesheet-selection-outlet="#samples-table"
  <% end %>
  data-action="
    nextflow--file:sendFileData->nextflow--samplesheet#updateFileData
    nextflow--metadata:sendMetadata->nextflow--samplesheet#updateMetadata
  "
>
  <h1
    class="
      mb-4 text-2xl font-extrabold leading-none tracking-tight text-slate-900
      md:text-5xl lg:text-4xl dark:text-white
    "
  ><%= @workflow.name %></h1>
  <p
    class="
      mb-4 text-lg font-normal text-slate-500 lg:text-xl dark:text-slate-400
    "
  >
    <%= @workflow.description %>
  </p>
  <%= helpers.turbo_frame_tag "workflow_execution_errors" %>

  <div
    role="alert"
    aria-live="assertive"
    aria-atomic="true"
    data-nextflow--samplesheet-target="formFieldError"
    class="
      hidden alert-component bg-red-50 border-red-300 dark:bg-red-900/20
      dark:border-red-800/50 dark:text-red-400 text-red-800 mb-2
    "
  >
    <div class="flex items-start w-full">
      <div class="flex-shrink-0 mr-3">
        <%= pathogen_icon :x_circle, color: :danger %>
      </div>
      <div class="flex-1 min-w-0 mt-0.5">
        <div
          class="text-sm font-medium leading-5"
          data-nextflow--samplesheet-target="formFieldErrorMessage"
        >
        </div>
      </div>
    </div>
  </div>

  <%= form_with url: url, method: (instance.nil? ? :post : :patch), data: { turbo_frame: "_top", "nextflow--samplesheet-target": "form" } do |form| %>
    <%= hidden_field_tag :format, :turbo_stream, id: "submission_turbo" %>

    <%= fields_for :workflow_execution do |workflow| %>
      <section class="mb-4">
        <div id="workflow_execution_name_field" class="form-field">
          <% label = label_attributes(!@automated_workflow) %>

          <%= workflow.label :name,
                         label[:name],
                         data: label[:data],
                         class: "block text-sm font-medium text-slate-900 dark:text-white" %>

          <%= workflow.text_field :name,
                              value: instance.present? ? instance.name : nil,
                              aria: {
                                required: (!@automated_workflow).to_s,
                              },
                              class:
                                "bg-slate-50 border border-slate-300 text-slate-900 text-sm rounded-lg block w-full p-2.5  dark:bg-slate-700 dark:border-slate-600 dark:placeholder-slate-400 dark:text-white" %>
          <div id="workflow_execution_name_error" class="mt-2 text-sm">
            <%= viral_help_text(state: :error, classes: "hidden") %>
          </div>
          <p
            id="<%= form.field_id("workflow_execution_name", "hint") %>"
            class="field-hint"
          >
            <%= t("components.nextflow_component.name.helper") %>
          </p>
        </div>
      </section>

      <%= workflow.hidden_field :namespace_id, value: @namespace_id %>

      <%= workflow.fields_for "metadata" do |metadata| %>
        <%= metadata.hidden_field :pipeline_id, value: @workflow.pipeline_id %>
        <%= metadata.hidden_field :workflow_version, value: @workflow.version %>
      <% end %>

      <%= workflow.fields_for "workflow_params" do |fields| %>
        <% @workflow.workflow_params.each do |item, definition| %>
          <h2 class="text-lg font-extrabold dark:text-white">
            <%= definition[:title] %>
          </h2>
          <p class="mb-2 font-normal text-slate-500 dark:text-slate-400">
            <%= definition[:description] %>
          </p>
          <div class="grid grid-cols-1 gap-4 mb-8">
            <% definition[:properties].each do |name, property| %>
              <% if item == :input_output_options && property[:format] == "file-path" %>
                <% unless @automated_workflow %>
                  <turbo-frame
                    id="samplesheet_message"
                    data-nextflow--samplesheet-target="samplesheetMessagesContainer"
                  >
                    <%= viral_alert(
                      message:
                        t(
                          "components.nextflow_component.loading_samplesheet",
                          count: @sample_count,
                        ),
                      dismissible: true,
                      auto_dismiss: true,
                      classes: "mb-2",
                    ) %>
                  </turbo-frame>

                  <%= render Nextflow::SamplesheetComponent.new(
                    schema: property[:schema],
                    namespace_id:,
                    fields: metadata_fields,
                    workflow_params: {
                      name: @workflow.name,
                      version: @workflow.version,
                    },
                  ) %>
                  <div
                    class="flex justify-center"
                    id="samplesheet-spinner"
                    data-nextflow--samplesheet-target="samplesheetSpinner"
                  >
                    <div
                      class="
                        flex items-center w-full max-w-xs p-4 space-x-2 text-gray-500 bg-white
                        rounded-lg rtl:space-x-reverse rtl:divide-x-reverse dark:text-gray-400
                        dark:divide-gray-700 dark:bg-gray-800
                      "
                      role="alert"
                    >
                      <%= pathogen_icon :faded_spinner, library: "animated", color: :primary %>
                      <span class="text-sm font-normal"><%= t("components.nextflow_component.processing_samplesheet") %></span>
                    </div>
                  </div>
                <% end %>
              <% else %>
                <div>
                  <% if property[:type] != 'boolean' %>
                    <%= fields.label name, :class => "block mb-2 text-sm font-medium text-slate-900 dark:text-white" do %>
                      <%= property[:description] %>
                      <% if property[:required] %>
                        <%= viral_pill(text: t(:"components.nextflow.required"), color: :primary) %>
                      <% end %>
                    <% end %>
                    <%= form_input(fields, name, property, property[:required], instance) %>
                  <% else %>
                    <% value =
                      (
                        if instance.present?
                          instance["workflow_params"][name.to_s]
                        else
                          property[:default]
                        end
                      ) %>
                    <%= viral_prefixed_boolean(form: fields, name:, value: ActiveModel::Type::Boolean.new.cast(value)) do |input| %>
                      <%= input.with_prefix do %>
                        <%= format_name_as_arg(name) %>
                      <% end %>
                      <%= input.with_legend(classes: 'block mb-2 text-sm font-medium text-slate-900 dark:text-white') do %>
                        <%= property[:description] %>
                        <% if property[:required] %>
                          <%= viral_pill(text: t(:"components.nextflow.required"), color: :primary) %>
                        <% end %>
                      <% end %>
                    <% end %>
                  <% end %>
                  <% if property[:help_text].present? %>
                    <%= viral_help_text do %>
                      <%= property[:help_text] %>
                    <% end %>
                  <% end %>
                </div>
              <% end %>
            <% end %>
          </div>
        <% end %>
      <% end %>

      <% if @automated_workflow %>
        <div class="flex items-center h-5 mb-4">
          <%= workflow.check_box :update_samples,
                             { checked: instance.present? && instance["update_samples"] } %>
          <%= workflow.label :update_samples,
                         t(:"components.nextflow.update_samples"),
                         class: "mr-2 text-sm font-medium text-slate-900 dark:text-white" %>
        </div>
      <% else %>
        <div
          class="flex mb-4"
          id="update-samples-spinner"
          data-nextflow--samplesheet-target="updateSamplesSpinner"
        >
          <div
            class="
              flex items-center w-full pr-4 space-x-2 text-gray-500 bg-white rounded-lg
              rtl:space-x-reverse rtl:divide-x-reverse dark:text-gray-400 dark:divide-gray-700
              dark:bg-gray-800
            "
            role="alert"
          >
            <%= pathogen_icon :faded_spinner, library: "animated", color: :primary %>
            <span class="text-sm font-medium text-slate-900 dark:text-white">
              <%= t("components.nextflow.verifying_update_samples") %>
            </span>
          </div>
        </div>
        <div class="hidden flex items-center h-5 mb-4" aria-hidden="true">
          <%= workflow.check_box :update_samples,
                             {
                               checked: instance.present? && instance["update_samples"],
                               data: {
                                 "nextflow--samplesheet-target": "updateSamplesCheckbox",
                               },
                             } %>
          <label
            class="
              block mb-2 text-sm font-medium text-slate-900 dark:text-white mr-2 text-sm
              font-medium text-slate-900 dark:text-white
            "
            for="workflow_execution_update_samples"
            data-nextflow--samplesheet-target="updateSamplesLabel"
          >
          </label>
        </div>
      <% end %>
      <div class="flex items-center h-5 mb-4">
        <%= workflow.check_box :email_notification,
                           {
                             checked:
                               instance.present? && instance["email_notification"],
                           } %>
        <%= workflow.label :email_notification,
                       t(:"components.nextflow.email_notification"),
                       class: "mr-2 text-sm font-medium text-slate-900 dark:text-white" %>
      </div>
      <%# do not render checkbox for an automated workflow execution %>
      <% if @namespace_type && !@samples.empty? %>
        <div class="flex items-center h-5 mb-4">
          <%= workflow.check_box :shared_with_namespace,
                             {
                               checked:
                                 instance.present? && instance["shared_with_namespace"],
                             } %>
          <%= workflow.label :shared_with_namespace,
                         t(
                           :"components.nextflow.shared_with.#{@namespace_type.downcase}",
                         ),
                         class: "mr-2 text-sm font-medium text-slate-900 dark:text-white" %>
        </div>
      <% end %>
    <% end %>

    <button
      class="button button-primary"
      data-nextflow--samplesheet-target="submit"
      <% if @automated_workflow %>
      type="submit"
      <% else %>
      type="button"
      disabled="disabled"
      data-action="click->nextflow--samplesheet#submitSamplesheet"
      <% end %>
    >
      <% if instance.nil? %>
        <%= t(:"workflow_executions.submissions.create.submit") %>
      <% else %>
        <%= t("common.actions.update") %>
      <% end %>
    </button>
  <% end %>

  <div
    class="flex items-center p-4 space-x-4 hidden"
    data-nextflow--samplesheet-target="submissionSpinner"
  >
    <%= render SpinnerComponent.new(
      message: t("components.nextflow_component.processing_request"),
      id: "nextflow-processing-request-spinner",
    ) %>
  </div>

  <% unless @automated_workflow %>
    <%= form_with(
      url: samplesheet_workflow_executions_submissions_path,
      method: :post,
      data: {
        "nextflow--samplesheet-target": "samplesheetParamsForm",
      },
    ) do |f| %>
    <% end %>
  <% end %>
</div>
