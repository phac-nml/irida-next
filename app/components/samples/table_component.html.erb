<% if @has_samples && @pagy.vars[:size].positive? %>
  <%= render Viral::BaseComponent.new(**wrapper_arguments) do %>
    <%= render Viral::BaseComponent.new(**system_arguments) do %>
      <%= render LiveRegionComponent.new(controller: "selection") %>
      <%= render LiveRegionComponent.new(
        controller: "announcement",
        data: {
          controller: "announcement",
        },
      ) %>

      <table
        class="samples-table"
        style="--puid-width: <%= helpers.puid_width(object_class: Sample, has_checkbox: @abilities[:select_samples]) %>;"
        data-controller="table"
        data-action="focusin->table#handleCellFocus"
        role="grid"
        aria-label="<%= t('.table_label') %>"
        aria-colcount="<%= @columns.length + @metadata_fields.length %>"
        aria-rowcount="<%= @pagy.count + 1 %>"
      >
        <%# Target for virtual scroll header manipulation %>
        <thead
          role="rowgroup"
          class="samples-table__header"
          data-virtual-scroll-target="header"
        >
          <tr role="row" aria-rowindex="1" class="samples-table__header-row">
            <% @columns.each_with_index do |column, index| %>
              <%= render_cell(
              tag: 'th',
              role: 'columnheader',
              scope: 'col',
              **helpers.aria_sort(column, @sort_key, @sort_direction),
              aria: { colindex: index + 1 },
              classes: class_names('samples-table__header-cell', 'samples-table__header-cell--sticky-puid': index.zero?, 'samples-table__header-cell--sticky-name': index == 1)
                ) do %>
                <div class="samples-table__header-cell-content">
                  <% if index.zero? && @abilities[:select_samples] %>
                    <%= check_box_tag "select-page",
                    "1",
                    false,
                    {
                      id: "select-page",
                      tabindex: "-1",
                      aria: {
                        label: t(".select_all.aria_label"),
                      },
                      data: {
                        table: true,
                        action: "input->selection#togglePage",
                        controller: "filters",
                        selection_target: "selectPage",
                      },
                    } %>
                  <% end %>

                  <%= render SortComponent.new(
                    sort: @search_params["sort"],
                    label: t(".#{column}"),
                    url: sort_url(column),
                    field: column,
                    tabindex: "-1",
                    data: {
                      turbo_action: "replace",
                    },
                  ) %>
                </div>
              <% end %>
            <% end %>

            <% @metadata_fields.each_with_index do |field, field_index| %>
              <%= render_cell(
              tag: 'th',
              role: 'columnheader',
              **helpers.aria_sort("metadata_#{field}", @sort_key, @sort_direction),
              data: {
                "field-id": field
              },
              aria: { colindex: @columns.length + field_index + 1 },
              scope: 'col',
              classes: class_names('samples-table__header-cell samples-table__header-cell--metadata')
            ) do %>
                <%= render SortComponent.new(
                  sort: @search_params["sort"],
                  label: field,
                  url: sort_url("metadata_#{field}"),
                  field: "metadata_#{field}",
                  tabindex: "-1",
                  data: {
                    turbo_action: "replace",
                  },
                ) %>
              <% end %>
            <% end %>
          </tr>
        </thead>

        <%# Target for virtual scroll body manipulation %>
        <tbody
          role="rowgroup"
          id="samples-table-body"
          class="samples-table__body"
          data-virtual-scroll-target="body"
        >
          <% @samples.each_with_index do |sample, row_index| %>
            <%= render Viral::BaseComponent.new(**row_arguments(sample, row_index)) do %>
              <% @columns.each_with_index do |column, index| %>
                <%= render_cell(
                tag: index.zero? ? 'th' : 'td',
                role: index.zero? ? 'rowheader' : 'gridcell',
                scope: index.zero? ? 'row' : nil,
                aria: { colindex: index + 1 },
                classes: class_names('samples-table__cell', 'samples-table__cell--sticky-puid': index.zero?, 'samples-table__cell--sticky-name': index == 1)
              ) do %>
                  <div class="samples-table__cell-content">
                    <% if index.zero? && @abilities[:select_samples] %>
                      <%= check_box_tag "sample_ids[]",
                      sample.id,
                      false,
                      {
                        id: dom_id(sample, :checkbox),
                        tabindex: "-1",
                        aria: {
                          label: t(".row.aria_label", name: sample.name),
                        },
                        data: {
                          table: true,
                          action: "input->selection#toggle",
                          selection_target: "rowSelection",
                        },
                      } %>
                    <% end %>

                    <% if column == :puid %>
                      <span class="samples-table__cell--puid-content">
                        <%= highlight(
                          sample[column],
                          defined?(@search_params[:name_or_puid_cont]) &&
                            @search_params[:name_or_puid_cont],
                          highlighter: '<mark class="samples-table__highlight">\1</mark>',
                        ) %>
                      </span>
                    <% elsif column == :name %>
                      <%= link_to(
                    sample_path(sample),
                    data: { turbo: false },
                    tabindex: "-1",
                    class: "samples-table__cell-link"
                  ) do %>
                        <%= highlight(
                          sample[column],
                          defined?(@search_params[:name_or_puid_cont]) &&
                            @search_params[:name_or_puid_cont],
                          highlighter: '<mark class="samples-table__highlight">\1</mark>',
                        ) %>
                      <% end %>
                    <% elsif column == "namespaces.puid" %>
                      <%= link_to sample.project.puid,
                      namespace_project_samples_path(sample.project.namespace.parent, sample.project),
                      data: {
                        turbo: false,
                      },
                      tabindex: "-1",
                      class: "samples-table__cell-link" %>
                    <% elsif column == :created_at %>
                      <%= helpers.local_date(sample[column], :long) %>
                    <% elsif column == :updated_at || column == :attachments_updated_at %>
                      <% if sample[column].present? %>
                        <%= helpers.local_time_ago(sample[column]) %>
                      <% end %>
                    <% else %>
                      <%= sample[column.to_sym] %>
                    <% end %>
                  </div>
                <% end %>
              <% end %>

            <% end %>
          <% end %>
        </tbody>

        <% if @abilities[:select_samples] && @has_samples %>
          <tfoot role="rowgroup" class="samples-table__footer">
            <tr role="row">
              <td
                class="
                  samples-table__footer-cell samples-table__footer-cell--sticky
                "
                colspan="2"
              >
                <span class="samples-table__footer-stats">
                  <%= t(".counts.samples") %>:
                  <strong><%= @pagy.count %></strong>
                </span>

                <span class="samples-table__footer-stats">
                  <%= t(".counts.selected") %>:
                  <strong data-selection-target="selected">0</strong>
                </span>
              </td>

              <td
                colspan="<%= @columns.count + @metadata_fields.count - 2 %>"
                class="samples-table__footer-cell"
              ></td>
            </tr>
          </tfoot>
        <% end %>
      </table>

      <%# Template container for virtualized metadata cells - stored outside table to avoid HTML5 foster parenting %>
      <div
        id="virtual-scroll-templates"
        class="samples-table__hidden"
        aria-hidden="true"
        data-virtual-scroll-target="templateContainer"
      >
        <% @samples.each do |sample| %>
          <div data-sample-id="<%= sample.id %>">
            <% @initial_metadata_fields.each_with_index do |field, field_index| %>
              <template data-field="<%= field %>">
                <% field_colindex = @columns.length + @metadata_fields.index(field) + 1 %>
                <% if @abilities[:edit_sample_metadata] && sample.updatable_field?(field) %>
                  <%= render Samples::EditableCell.new(
                    field: field,
                    sample: sample,
                    aria: {
                      colindex: field_colindex,
                    },
                  ) %>
                <% else %>
                  <%= render_cell(tag: 'td', role: 'gridcell', aria: { colindex: field_colindex }, classes: 'samples-table__cell', data: { "field-id": field }) do %>
                    <%= sample.metadata[field] %>
                  <% end %>
                <% end %>
              </template>
            <% end %>
          </div>
        <% end %>
      </div>

      <%# Turbo frame for deferred template loading (projects only) %>
      <% if @namespace.is_a?(Namespaces::ProjectNamespace) && @deferred_metadata_fields.any? %>
        <% deferred_params = {
          q: @search_params,
          limit: @pagy.vars[:limit],
          page: @pagy.page,
          format: :turbo_stream,
        }.to_query %>
        <% deferred_url =
          deferred_templates_namespace_project_samples_path(
            @namespace.parent,
            @namespace.project,
          ) + "?#{deferred_params}" %>
        <%= helpers.turbo_frame_tag "deferred-templates",
                                src: deferred_url,
                                loading: "eager",
                                class: "hidden",
                                "aria-hidden": "true",
                                data: {
                                  "virtual-scroll-target": "deferredFrame",
                                  turbo_action: "advance",
                                } %>
      <% end %>

      <%# Loading overlay %>
      <div class="samples-table__loading" data-virtual-scroll-target="loading">
        <div class="samples-table__loading-content">
          <div class="samples-table__loading-inner">
            <%= pathogen_icon :faded_spinner, library: "animated", color: :primary, size: :xl %>
            <span class="samples-table__sr-only"><%= t("shared.loading.samples_list_skeleton.loading") %></span>
          </div>
        </div>
      </div>
    <% end %>

    <%= render Viral::Pagy::FullComponent.new(@pagy, item: t(".limit.item")) %>

    <% if @abilities[:edit_sample_metadata] %>
      <template data-editable-cell-target="formTemplate">
        <%= form_with(
              url: sample_metadatum_path(sample_id: 'SAMPLE_ID_PLACEHOLDER', id: 'FIELD_ID_PLACEHOLDER'),
              method: :patch,
              class: "w-full"
            ) do |form| %>
          <%= form.hidden_field :format, value: "turbo_stream" %>
          <%= form.hidden_field :value, value: "FIELD_VALUE_PLACEHOLDER" %>
          <%= form.hidden_field :cell_id, value: "CELL_ID_PLACEHOLDER" %>
        <% end %>
      </template>
      <div
        id="editable-cell-form-container"
        class="invisible"
        data-editable-cell-target="formContainer"
      ></div>
      <template data-editable-cell-target="confirmDialogTemplate">
        <%= viral_dialog(open: false) do |dialog| %>
          <% dialog.with_header(
            title: t("shared.samples.metadata.editing_field_cell.dialog.title"),
          ) %>

          <p class="text-base leading-8 text-slate-900 dark:text-white text-wrap">
            <span data-message-type="wov" class="samples-table__hidden">
              <%= raw t(
                "shared.samples.metadata.editing_field_cell.dialog.description_with_new_value.with_original_value",
              ) %>
            </span>

            <span data-message-type="woov" class="samples-table__hidden">
              <%= raw t(
                "shared.samples.metadata.editing_field_cell.dialog.description_with_new_value.without_original_value",
              ) %>
            </span>

            <span data-message-type="wonv" class="samples-table__hidden">
              <%= raw t(
                "shared.samples.metadata.editing_field_cell.dialog.description_without_new_value",
              ) %>
            </span>
          </p>

          <% dialog.with_secondary_action do %>
            <%= viral_button(value: "confirm", state: :primary) do
              t("shared.samples.metadata.editing_field_cell.dialog.confirm_button")
            end %>

            <%= viral_button(value: "cancel", state: :default) do
              t("shared.samples.metadata.editing_field_cell.dialog.discard_button")
            end %>
          <% end %>
        <% end %>
      </template>
      <div data-editable-cell-target="confirmDialogContainer"></div>
    <% end %>
  <% end %>
<% else %>
  <div class="empty_state_message">
    <%= viral_empty(
      title: @empty[:title],
      description: @empty[:description],
      icon_name: Sample.icon,
    ) %>
  </div>
<% end %>
