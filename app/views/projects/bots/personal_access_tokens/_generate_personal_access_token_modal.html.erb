<%= viral_dialog(open: open) do |dialog| %>
  <% dialog.with_header(
    title:
      t(
        "projects.bots.index.bot_listing.generate_personal_access_token_modal.title",
      ),
  ) %>
  <div class="mb-6 text-lg font-normal text-slate-500 dark:text-slate-400">
    <p class="dark:text-slate-400">
      <%= t(
        "projects.bots.index.bot_listing.generate_personal_access_token_modal.description",
        bot_account: @bot_account.user.email,
      ) %>
    </p>
  </div>

  <div class="mb-4">
    <%= turbo_frame_tag("personal-access-token-error-alert") %>
  </div>

  <%= form_for(@personal_access_token, url: namespace_project_bot_personal_access_tokens_path, method: :post,  html: { novalidate: true}) do |form| %>
    <div class="grid gap-4">
      <%= render partial: "shared/form/required_field_legend" %>
      <% invalid_token_name = @personal_access_token.errors.include?(:name) %>
      <div class="form-field <%= 'invalid' if invalid_token_name %>">
        <%= form.label :name, data: { required: true } %>
        <%= form.text_field :name,
                        required: true,
                        class: "form-control",
                        aria: {
                          describedby:
                            (
                              if invalid_token_name
                                form.field_id(:name, "error")
                              else
                                nil
                              end
                            ),
                          invalid: invalid_token_name,
                          required: true,
                        },
                        autofocus: invalid_token_name %>
        <% if invalid_token_name %>
          <%= render "shared/form/field_errors",
          id: form.field_id(:name, "error"),
          errors: @personal_access_token.errors.full_messages_for(:name) %>
        <% end %>
      </div>
      <div class="form-field">
        <%= pathogen_datepicker(
          id: form.field_id(:expires_at),
          input_name: form.field_name(:expires_at),
          label:
            t(
              "projects.bots.index.bot_listing.generate_personal_access_token_modal.expires_at",
            ),
          selected_date: @personal_access_token[:expires_at],
        ) %>
      </div>
      <% invalid_scopes = @personal_access_token.errors.include?(:scopes) %>
      <div class="form-field <%= 'invalid' if invalid_scopes %>">
        <fieldset>
          <legend data-required="true"><%= t(:"activerecord.attributes.personal_access_token.scopes") %></legend>
          <% Irida::Auth.all_available_scopes.each do |scope| %>
            <div class="flex">
              <div class="flex items-center h-5">
                <%= form.check_box :scopes,
                               {
                                 checked: @personal_access_token.scopes.include?(scope.to_s),
                                 aria: {
                                   describedby:
                                     (
                                       if invalid_scopes
                                         form.field_id(:scopes, "error")
                                       else
                                         nil
                                       end
                                     ),
                                   invalid: invalid_scopes,
                                 },
                                 include_hidden: false,
                                 multiple: true,
                               },
                               scope %>
              </div>
              <div class="ml-2 text-sm">
                <%= label_tag form.field_id(:scopes, scope.to_s),
                scope,
                class: "font-medium text-slate-900 dark:text-slate-300" %>
                <p
                  id="<%= form.field_id(:scopes, scope.to_s, "help-text") %>"
                  class="
                    text-xs font-normal text-slate-500 dark:text-slate-400
                  "
                ><%= t("auth.scopes.#{scope}") %></p>
              </div>
            </div>
          <% end %>
        </fieldset>
        <% if invalid_scopes %>
          <%= render "shared/form/field_errors",
          id: form.field_id(:scopes, "error"),
          errors: @personal_access_token.errors.full_messages_for(:scopes) %>
        <% end %>
      </div>

    </div>
    <div class="mt-4">
      <%= form.submit t(
                    "projects.bots.index.bot_listing.generate_personal_access_token_modal.submit",
                  ),
                  class: "button button-primary" %>
      <button
        type="button"
        class="button button-default"
        data-action="click->viral--dialog#close"
      >
        <%= t("projects.bots.index.bot_listing.generate_personal_access_token_modal.cancel") %>
      </button>
    </div>
  <% end %>
<% end %>
