<%= turbo_refreshes_with method: :morph, scroll: :preserve %>
<%= turbo_frame_tag "sample_modal" %>
<%= turbo_frame_tag "samples_dialog" %>

<%= render Viral::PageHeaderComponent.new(title: @sample.name, id: @sample.puid, subtitle: @sample.description) do |component| %>
  <%= viral_pill(text: @sample.puid, color: :blue) %>
  <% component.with_buttons do %>
    <div class="flex flex-col @lg:flex-row @lg:space-x-2 space-y-2">
      <% if @allowed_to[:update_sample] %>
        <%= link_to(
          t("projects.samples.show.edit_button"),
          edit_namespace_project_sample_path(id: @sample.id),
          class: "button button-default w-full",
        ) %>
      <% end %>
      <% if @allowed_to[:destroy_sample] %>
        <%= button_to(
          t('common.actions.remove'),
          new_samples_deletions_path,
          params: {
            namespace_id: @project.namespace.id,
            deletion_type: "single",
            sample_id: @sample.id,
          },
          method: :get,
          data: {
            turbo_stream: true,
          },
          class: "button button-default w-full",
        ) %>
      <% end %>
    </div>
  <% end %>
<% end %>

<div>
  <%= render Pathogen::Tabs.new(
    id: "sample-tabs",
    label: t("projects.samples.show.nav_aria_label"),
    default_index: @tab == "metadata" ? 1 : (@tab == "history" ? 2 : 0),
    sync_url: true
  ) do |tabs| %>
    <%# Tab buttons %>
    <% tabs.with_tab(
      id: "files-tab",
      label: t(:"projects.samples.show.tabs.files"),
      selected: (@tab == "files") || (@tab.nil?)
    ) %>
    <% tabs.with_tab(
      id: "metadata-tab",
      label: t(:"projects.samples.show.tabs.metadata"),
      selected: @tab == "metadata"
    ) %>
    <% tabs.with_tab(
      id: "history-tab",
      label: t(:"projects.samples.show.tabs.history"),
      selected: @tab == "history"
    ) %>

    <%# Tab panels with lazy loading or direct rendering based on query param %>
    <% tabs.with_panel(id: "files-panel", tab_id: "files-tab") do %>
      <% if @tab.nil? || @tab == "files" %>
        <%# Direct render for backward compatibility with query params %>
        <%= render partial: "projects/samples/attachments/table" %>
      <% else %>
        <%= turbo_frame_tag "files-content",
          src: namespace_project_sample_path(id: @sample.id, tab: "files", format: :turbo_stream),
          loading: :lazy,
          refresh: "morph" do %>
          <%= render partial: "shared/loading/table" %>
        <% end %>
      <% end %>
    <% end %>

    <% tabs.with_panel(id: "metadata-panel", tab_id: "metadata-tab") do %>
      <% if @tab == "metadata" %>
        <%# Direct render for backward compatibility with query params %>
        <%= render partial: "projects/samples/metadata/table", locals: { sample_metadata: @sample_metadata } %>
      <% else %>
        <%= turbo_frame_tag "metadata-content",
          src: namespace_project_sample_path(id: @sample.id, tab: "metadata", format: :turbo_stream),
          loading: :lazy,
          refresh: "morph" do %>
          <%= render partial: "shared/loading/table" %>
        <% end %>
      <% end %>
    <% end %>

    <% tabs.with_panel(id: "history-panel", tab_id: "history-tab") do %>
      <% if @tab == "history" %>
        <%# Direct render for backward compatibility with query params %>
        <%= render partial: "projects/samples/history/content" %>
      <% else %>
        <%= turbo_frame_tag "history-content",
          src: namespace_project_sample_path(id: @sample.id, tab: "history", format: :turbo_stream),
          loading: :lazy,
          refresh: "morph" do %>
          <%= render partial: "shared/loading/history" %>
        <% end %>
      <% end %>
    <% end %>
  <% end %>
</div>
