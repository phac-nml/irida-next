<%= render Viral::PageHeaderComponent.new(title: t(:'.title'), subtitle: t(:'.subtitle', namespace_type: @namespace.class.model_name.human, namespace_name: @namespace.name)) do |component| %>
  <%= component.with_icon(name: "users", classes: "h-14 w-14 text-primary-700") %>
  <%= component.with_buttons do %>
    <% if allowed_to?(:create_member?, @namespace) %>
      <%= link_to t(:".add"),
      new_group_member_path(@namespace),
      class: "btn btn-primary",
      "aria-label": t(:".actions.button_add_aria_label") %>
    <% end %>
  <% end %>
<% end %>

<div class="bg-white dark:bg-gray-800">
  <div class="flex flex-col">
    <div class="overflow-x-auto">
      <div class="shadow">
        <%= turbo_frame_tag("member-update-alert") %>
        <table class="min-w-full table-fixed dark:divide-gray-600">
          <thead class="text-gray-700 bg-gray-50 dark:bg-gray-700 dark:text-gray-400">
            <tr>
              <th scope="col" class="px-6 py-3 text-left"><%= t(:"groups.members.index.table_header.username") %></th>
              <th scope="col" class="px-6 py-3 text-left"><%= t(:"groups.members.index.table_header.access_level") %></th>
              <th scope="col" class="px-6 py-3 text-left"><%= t(:"groups.members.index.table_header.source") %></th>
              <th scope="col" class="px-6 py-3 text-left"><%= t(:"groups.members.index.table_header.access_granted") %></th>
              <th scope="col" class="px-6 py-3 text-right"><%= t(:"groups.members.index.table_header.action") %></th>
            </tr>
          </thead>
          <tbody
            class="
              bg-white
              divide-y
              divide-gray-200
              dark:bg-gray-800
              dark:divide-gray-700
            "
          >
            <% @members.each do |member| %>
              <% member_source = Member.membership_source(@namespace, member.user) %>
              <tr
                class="
                  text-sm
                  font-normal
                  text-gray-500
                  dark:text-gray-400
                "
              >
                <td class="px-6 py-4">
                  <div class="text-sm font-normal text-gray-500 dark:text-gray-400"><%= member.user.email %>
                    <% if current_user == member.user %>
                      <span
                        class="
                          bg-green-200
                          text-green-800
                          text-xs
                          font-medium
                          ml-2
                          px-2.5
                          py-0.5
                          rounded-full
                          dark:bg-green-900
                          dark:text-green-300
                        "
                      >
                        <%= t(:"activerecord.models.member.its_you") %>
                      </span>
                    <% end %>
                  </div>
                </td>
                <td class="px-6 py-4">
                  <% if (member.user != current_user && allowed_to?(:update_member?, @namespace) &&
                   member.access_level <= @access_levels.values.last) && !member_source.key?(:inherited_namespace_path) %>
                    <%= turbo_frame_tag("member-#{member.id}-access-level") do %>
                      <%= render partial: "groups/members/access_level",
                      locals: {
                        member: member,
                        access_levels: @access_levels
                      } %>
                    <% end %>
                  <% else %>
                    <%= t(:".access_level.level_#{member.access_level}") %>
                  <% end %>
                </td>
                <td class="px-6 py-4">
                  <% if !member_source.key?(:inherited_namespace_path) %>
                    <div class="text-sm font-normal text-gray-500 dark:text-gray-400"><%= member_source[:label] %></div>
                  <% else %>
                    <%= viral_tooltip(title: t(:"groups.members.index.inherited_from")) do %>
                      <%= link_to member_source[:label],
                      member_source[:inherited_namespace_path],
                      class: "text-grey-900 dark:text-grey-100 font-semibold hover:underline" %>
                    <% end %>
                  <% end %>
                </td>
                <td class="px-6 py-4">
                  <div>
                    <% if member.user.email != member.created_by.email %>
                      <span class="text-sm"><%= distance_of_time_in_words(Time.now, member.created_at) %> by <span class="block">
                        <%= member.created_by.email %>
                      </span>
                    <% else %>
                      <span class="text-sm"><%= distance_of_time_in_words(Time.now, member.created_at) %></span>
                    <% end %>

                    <%= turbo_frame_tag("member-#{member.id}-access-level-updated") do %>
                      <% if member.created_at < member.updated_at %>
                        <%= render UpdatedComponent.new(
                          updated_at: member.updated_at
                        ) %>
                      <% end %>
                    <% end %>
                  </div>
                </td>

                <% if !member_source.key?(:inherited_namespace_path) && allowed_to?(:destroy_member?, @namespace) %>
                  <td class="px-4 py-3 text-right">
                    <%= viral_dropdown(icon: "ellipsis_vertical",
                                     classes: "member-settings-ellipsis",
                                     aria: { label: t(:'groups.members.index.actions.member_dropdown_aria_label',
                                     member: member.user.email) }) do |dropdown| %>
                      <%= dropdown.item(
                        label: t(:"groups.members.index.remove"),
                        url: group_member_path(@namespace, member),
                        data: {
                          turbo_method: :delete,
                          turbo_confirm: t(:"groups.members.index.remove_confirmation")
                        },
                        aria: {
                          label:
                            t(
                              :"groups.members.index.actions.link_remove_aria_label",
                              member: member.user.email
                            )
                        }
                      ) %>
                    <% end %>
                  </td>
                <% end %>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>
