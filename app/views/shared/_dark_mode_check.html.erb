<script>
  // On page load or when changing themes, best to add inline in `head` to avoid FOUC
  // CRITICAL: This script must execute synchronously before page render to prevent flash
  (function() {
    'use strict';

    // Constants for theme management
    const THEME_KEY = 'theme';
    const THEMES = {
      DARK: 'dark',
      LIGHT: 'light',
      SYSTEM: 'system'
    };
    const ALLOWED_THEMES = Object.values(THEMES);

    /**
     * Check if localStorage is available and accessible
     * @returns {boolean} True if localStorage can be used
     */
    function isLocalStorageAvailable() {
      try {
        const test = '__ls_test__';
        localStorage.setItem(test, test);
        localStorage.removeItem(test);
        return true;
      } catch (e) {
        return false;
      }
    }

    /**
     * Safely get theme from localStorage with validation
     * @returns {string} The current theme (validated)
     */
    function getCurrentTheme() {
      if (!isLocalStorageAvailable()) {
        return THEMES.SYSTEM;
      }

      try {
        const stored = localStorage.getItem(THEME_KEY);
        return ALLOWED_THEMES.includes(stored) ? stored : THEMES.SYSTEM;
      } catch (e) {
        console.error('Failed to read theme from localStorage:', e);
        return THEMES.SYSTEM;
      }
    }

    /**
     * Check if current theme is system preference
     * @param {string} theme - The theme to check
     * @returns {boolean} True if using system preference
     */
    function isSystemTheme(theme) {
      return theme === THEMES.SYSTEM;
    }

    /**
     * Determine if dark mode should be active
     * @param {string} theme - The theme to evaluate
     * @returns {boolean} True if dark mode should be active
     */
    function isDarkMode(theme) {
      if (theme === THEMES.DARK) {
        return true;
      }

      if (theme === THEMES.LIGHT) {
        return false;
      }

      // System preference
      return window.matchMedia('(prefers-color-scheme: dark)').matches;
    }

    /**
     * Apply theme to the document
     * @param {boolean} isDark - Whether dark mode should be active
     */
    function applyTheme(isDark) {
      const docEl = document.documentElement;

      // Use toggle for cleaner class management
      docEl.classList.toggle(THEMES.DARK, isDark);
      docEl.classList.toggle(THEMES.LIGHT, !isDark);

      // Update color-scheme meta tag for native browser UI elements
      updateColorSchemeMeta(isDark);
    }

    /**
     * Update or create color-scheme meta tag
     * @param {boolean} isDark - Whether dark mode is active
     */
    function updateColorSchemeMeta(isDark) {
      let meta = document.querySelector('meta[name="color-scheme"]');

      if (!meta) {
        meta = document.createElement('meta');
        meta.name = 'color-scheme';
        document.head.appendChild(meta);
      }

      meta.content = isDark ? 'dark' : 'light';
    }

    /**
     * Debounce function to prevent rapid consecutive calls
     * @param {Function} func - The function to debounce
     * @param {number} wait - Milliseconds to wait
     * @returns {Function} Debounced function
     */
    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    // Apply initial theme immediately (before page render)
    const initialTheme = getCurrentTheme();
    applyTheme(isDarkMode(initialTheme));

    // Set up watcher for system theme changes (debounced)
    const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)');
    const handleMediaChange = debounce(function(e) {
      // Re-read theme to avoid stale closure
      const currentTheme = getCurrentTheme();
      if (isSystemTheme(currentTheme)) {
        applyTheme(e.matches);
      }
    }, 150);

    mediaQuery.addEventListener('change', handleMediaChange);

    // Sync theme changes across browser tabs
    window.addEventListener('storage', function(event) {
      if (event.key === THEME_KEY) {
        // Always re-read from storage to avoid stale closure bug
        const newTheme = getCurrentTheme();
        const isNewDark = isDarkMode(newTheme);
        applyTheme(isNewDark);
      }
    });

    // Cleanup on Turbo navigation (for SPAs)
    document.addEventListener('turbo:before-render', function() {
      mediaQuery.removeEventListener('change', handleMediaChange);
    }, { once: true });
  })();
</script>
